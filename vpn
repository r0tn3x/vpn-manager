#!/bin/bash

# VPN Manager Script
# Author: r0nt3x
# Manages OpenVPN connections with ease

VPN_DIR="$HOME/VPN"
PID_FILE="/tmp/vpn_manager.pid"
LOG_FILE="/tmp/vpn_manager.log"
CONNECTION_FILE="/tmp/vpn_connection.info"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Function to print colored output
print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Function to check if OpenVPN is installed
# check_openvpn() {
#    if ! command -v openvpn &> /dev/null; then
#        print_error "OpenVPN is not installed!"
#        echo "Install it with: sudo apt install openvpn"
#        exit 1
#    fi
#}

# Function to check if VPN directory exists
check_vpn_dir() {
    if [ ! -d "$VPN_DIR" ]; then
        print_error "VPN directory not found: $VPN_DIR"
        echo "Create it with: mkdir -p $VPN_DIR"
        exit 1
    fi
}

# Function to show available VPN configs
show_available() {
    echo
    echo -e "${CYAN}"
    cat << "EOF"
╔════════════════════════════════════════════════════════════╗
║               Available VPN Configurations                 ║
╚════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
    echo
    
    if [ ! "$(ls -A $VPN_DIR/*.ovpn 2>/dev/null)" ]; then
        print_warning "No .ovpn files found in $VPN_DIR"
        return 1
    fi
    
    local count=0
    for config in "$VPN_DIR"/*.ovpn; do
        if [ -f "$config" ]; then
            local filename=$(basename "$config" .ovpn)
            local size=$(du -h "$config" | cut -f1)
            local modified=$(stat -c %y "$config" 2>/dev/null | cut -d' ' -f1)
            
            ((count++))
            echo -e "${GREEN}[$count]${NC} ${YELLOW}$filename${NC}"
            echo -e "    └─ File: $(basename "$config")"
            echo -e "    └─ Size: $size"
            echo -e "    └─ Modified: $modified"
            echo
        fi
    done
    
    if [ $count -eq 0 ]; then
        print_warning "No .ovpn files found in $VPN_DIR"
        return 1
    fi
    
    print_info "Total configurations: $count"
}

# Function to show VPN status
show_status() {
    echo
    echo -e "${CYAN}"
    cat << "EOF"
╔════════════════════════════════════════════════════════════╗
║                   VPN Connection Status                    ║
╚════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
    echo
    
    # Check if OpenVPN is running
    local vpn_pid=$(pgrep -f "openvpn.*\.ovpn" | head -1)
    
    if [ -z "$vpn_pid" ]; then
        print_warning "No active VPN connections"
        echo -e "${YELLOW}Status:${NC} OFFLINE"
        return 0
    fi
    
    print_success "VPN connection is ACTIVE"
    echo
    
    # Get connection details
    local vpn_process=$(ps -p $vpn_pid -o args= 2>/dev/null)
    local config_file=$(echo "$vpn_process" | grep -oP '([^ ]+\.ovpn)' | head -1)
    local config_name=$(basename "$config_file" .ovpn 2>/dev/null)
    
    # Calculate uptime
    local start_time=$(ps -p $vpn_pid -o lstart= 2>/dev/null)
    local start_epoch=$(date -d "$start_time" +%s 2>/dev/null)
    local current_epoch=$(date +%s)
    local uptime_seconds=$((current_epoch - start_epoch))
    local uptime_formatted=$(printf '%02d:%02d:%02d' $((uptime_seconds/3600)) $((uptime_seconds%3600/60)) $((uptime_seconds%60)))
    
    echo -e "${GREEN}Connection Details:${NC}"
    echo -e "  ${BLUE}├─${NC} PID: ${YELLOW}$vpn_pid${NC}"
    [ -n "$config_name" ] && echo -e "  ${BLUE}├─${NC} Config: ${YELLOW}$config_name${NC}"
    echo -e "  ${BLUE}├─${NC} Uptime: ${YELLOW}$uptime_formatted${NC}"
    
    # Check for tun/tap interfaces
    echo -e "  ${BLUE}└─${NC} Interfaces:"
    
    local found_interface=0
    for iface in $(ip -o link show | awk -F': ' '{print $2}' | grep -E '^(tun|tap)'); do
        found_interface=1
        local ip_addr=$(ip -4 addr show "$iface" 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -1)
        local status=$(ip link show "$iface" 2>/dev/null | grep -oP '(?<=state )\w+')
        
        echo -e "       ${CYAN}├─${NC} $iface: ${GREEN}$ip_addr${NC} (${status})"
        
        # Show received/transmitted data
        local rx_bytes=$(cat "/sys/class/net/$iface/statistics/rx_bytes" 2>/dev/null)
        local tx_bytes=$(cat "/sys/class/net/$iface/statistics/tx_bytes" 2>/dev/null)
        if [ -n "$rx_bytes" ] && [ -n "$tx_bytes" ]; then
            local rx_mb=$(echo "scale=2; $rx_bytes/1048576" | bc 2>/dev/null)
            local tx_mb=$(echo "scale=2; $tx_bytes/1048576" | bc 2>/dev/null)
            echo -e "       ${CYAN}└─${NC} Traffic: ↓ ${rx_mb}MB / ↑ ${tx_mb}MB"
        fi
    done
    
    if [ $found_interface -eq 0 ]; then
        echo -e "       ${YELLOW}└─ No tun/tap interfaces found${NC}"
    fi
    
    # Show routing info
    echo
    echo -e "${GREEN}Routing Information:${NC}"
    local default_route=$(ip route | grep "^default" | grep -E "(tun|tap)" | head -1)
    if [ -n "$default_route" ]; then
        print_success "VPN is routing traffic"
        echo -e "  ${CYAN}└─${NC} $default_route"
    else
        print_warning "VPN may not be routing traffic"
    fi
    
    # Try to get external IP
    echo
    echo -e "${GREEN}External IP:${NC}"
    local ext_ip=$(timeout 3 curl -s ifconfig.me 2>/dev/null || timeout 3 curl -s icanhazip.com 2>/dev/null)
    if [ -n "$ext_ip" ]; then
        echo -e "  ${CYAN}└─${NC} ${YELLOW}$ext_ip${NC}"
    else
        echo -e "  ${CYAN}└─${NC} ${YELLOW}Unable to fetch${NC}"
    fi
    
    echo
}

# Function to terminate all VPN connections
terminate_vpn() {
    echo
    echo -e "${CYAN}"
    cat << "EOF"
╔════════════════════════════════════════════════════════════╗
║                Terminating VPN Connections                 ║
╚════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
    echo
    
    local vpn_pids=$(pgrep -f "openvpn.*\.ovpn")
    
    if [ -z "$vpn_pids" ]; then
        print_info "No active VPN connections to terminate"
        return 0
    fi
    
    print_info "Found active VPN process(es)"
    
    # Try graceful shutdown first
    for pid in $vpn_pids; do
        print_info "Sending SIGTERM to PID $pid..."
        sudo kill -TERM "$pid" 2>/dev/null
    done
    
    # Wait a bit for graceful shutdown
    sleep 2
    
    # Force kill if still running
    vpn_pids=$(pgrep -f "openvpn.*\.ovpn")
    if [ -n "$vpn_pids" ]; then
        print_warning "Forcing termination..."
        for pid in $vpn_pids; do
            sudo kill -9 "$pid" 2>/dev/null
        done
    fi
    
    # Clean up files
    rm -f "$PID_FILE" "$CONNECTION_FILE"
    
    # Verify termination
    sleep 1
    if pgrep -f "openvpn.*\.ovpn" > /dev/null; then
        print_error "Failed to terminate all VPN connections"
        return 1
    else
        print_success "All VPN connections terminated successfully"
    fi
}

# Function to connect to VPN
connect_vpn() {
    local vpn_name="$1"
    
    echo
    echo -e "${CYAN}"
    cat << "EOF"
╔════════════════════════════════════════════════════════════╗
║                     Connecting to VPN                      ║
╚════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
    echo
    
    # Check if already connected
    if pgrep -f "openvpn.*\.ovpn" > /dev/null; then
        print_warning "VPN already connected!"
        echo
        read -p "Terminate existing connection and connect to $vpn_name? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            terminate_vpn
            echo
        else
            print_info "Keeping existing connection"
            return 1
        fi
    fi
    
    # Find the config file
    local config_path=""
    
    # Try exact match
    if [ -f "$VPN_DIR/${vpn_name}.ovpn" ]; then
        config_path="$VPN_DIR/${vpn_name}.ovpn"
    else
        # Try case-insensitive search
        config_path=$(find "$VPN_DIR" -maxdepth 1 -iname "${vpn_name}.ovpn" | head -1)
    fi
    
    if [ -z "$config_path" ] || [ ! -f "$config_path" ]; then
        print_error "No config file found for: $vpn_name"
        echo
        print_info "Available configurations:"
        show_available
        return 1
    fi
    
    print_info "Found config: $(basename "$config_path")"
    print_info "Starting OpenVPN..."
    
    # Create log file
    echo "=== VPN Connection Started at $(date) ===" > "$LOG_FILE"
    
    # Start OpenVPN in background
    sudo openvpn --config "$config_path" --daemon --log "$LOG_FILE" --writepid "$PID_FILE"
    
    # Wait a bit and check if connection started
    sleep 3
    
    if pgrep -f "openvpn.*\.ovpn" > /dev/null; then
        print_success "VPN connection initiated!"
        
        # Save connection info
        echo "NAME=$vpn_name" > "$CONNECTION_FILE"
        echo "CONFIG=$config_path" >> "$CONNECTION_FILE"
        echo "STARTED=$(date +%s)" >> "$CONNECTION_FILE"
        
        # Wait for interface to come up
        print_info "Waiting for VPN interface..."
        local max_wait=10
        local waited=0
        while [ $waited -lt $max_wait ]; do
            if ip link show | grep -qE '(tun|tap)'; then
                print_success "VPN interface is up!"
                echo
                show_status
                return 0
            fi
            sleep 1
            ((waited++))
            echo -n "."
        done
        
        echo
        print_warning "VPN process started but interface not detected yet"
        print_info "Check logs: tail -f $LOG_FILE"
    else
        print_error "Failed to start VPN connection"
        print_info "Check logs: cat $LOG_FILE"
        return 1
    fi
}

# Function to show usage
show_usage() {
    echo
    echo -e "${CYAN}"
    cat << "EOF"
╔════════════════════════════════════════════════════════════╗
║                    VPN Manager - Usage                     ║
║              OpenVPN Manager for CTF                       ║
║                      Author: r0nt3x                        ║
╚════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
    echo
    echo -e "${GREEN}Connection Commands:${NC}"
    echo "  vpn --<name>          Connect to VPN (e.g., vpn --dante-prolab)"
    echo "  vpn --terminate       Terminate all VPN connections"
    echo
    echo -e "${YELLOW}Information Commands:${NC}"
    echo "  vpn --available       Show available VPN configurations"
    echo "  vpn --status          Show current VPN connection status"
    echo "  vpn --help            Show this help message"
    echo
    echo -e "${BLUE}Examples:${NC}"
    echo "  vpn --dante-prolab    Connect to dante-prolab VPN"
    echo "  vpn --thm             Connect to TryHackMe VPN"
    echo "  vpn --htb             Connect to HackTheBox VPN"
    echo "  vpn --status          Check if VPN is connected"
    echo "  vpn --terminate       Disconnect from VPN"
    echo
    echo -e "${CYAN}Configuration:${NC}"
    echo -e "  VPN configs location: ${YELLOW}$VPN_DIR${NC}"
    echo -e "  Expected format: ${YELLOW}<name>.ovpn${NC}"
    echo
    echo -e "${MAGENTA}Note:${NC} OpenVPN requires sudo privileges for connection"
    echo
}

# Main script logic
main() {
    check_openvpn
    check_vpn_dir
    
    if [ $# -eq 0 ]; then
        show_usage
        exit 0
    fi
    
    case "$1" in
        --help|-h)
            show_usage
            ;;
        --available|-a)
            show_available
            ;;
        --status|-s)
            show_status
            ;;
        --terminate|-t|--kill|-k)
            terminate_vpn
            ;;
        --*)
            # Extract VPN name (remove leading --)
            local vpn_name="${1#--}"
            connect_vpn "$vpn_name"
            ;;
        *)
            print_error "Unknown option: $1"
            show_usage
            exit 1
            ;;
    esac
}

main "$@"
